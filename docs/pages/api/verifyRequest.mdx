# verifyRequest

Verify an ERC-8128 signed HTTP request.

## Usage

Pass a `Request`, a `verifyMessage` implementation, a `nonceStore`, and an optional policy. The function returns a `VerifyResult` indicating success or failure.

```typescript
import { verifyRequest } from '@slicekit/erc8128'

// Simple: request + required dependencies + policy
const result = await verifyRequest(request, verifyMessage, nonceStore, {
  maxValiditySec: 300,
})

if (result.ok) {
  console.log(`Authenticated: ${result.address} on chain ${result.chainId}`)
} else {
  console.log(`Failed: ${result.reason}`)
}
```

## Returns

[`VerifyResult`](/api/types#verifyresult)

An object indicating success or failure:

```typescript
if (result.ok) {
  // Success — access verified data
  result.address   // Ethereum address
  result.chainId   // Chain ID
  result.label     // Signature label
  result.components // Signed components
  result.replayable // true if nonce-less
  result.binding   // "request-bound" or "class-bound"
} else {
  // Failure — check reason
  result.reason    // VerifyFailReason
  result.detail    // Optional detail message
}
```

## Parameters

```typescript
verifyRequest(
  request: Request,
  verifyMessage: VerifyMessageFn,
  nonceStore: NonceStore,
  policy?: VerifyPolicy,
  setHeaders?: (name: string, value: string) => void
): Promise<VerifyResult>
```

### request

- **Type:** `Request`

The Request to verify.

### verifyMessage

- **Type:** [`VerifyMessageFn`](/api/types#verifymessagefn)

Signature verification function (e.g. viem-compatible).

### nonceStore

- **Type:** [`NonceStore`](/api/types#noncestore)

Replay protection store for non-replayable requests.

### policy (optional)

- **Type:** [`VerifyPolicy`](/api/types#verifypolicy)

Verification policy with rules for validation. Signatures are verified in the order they appear in `Signature-Input` after filtering to ERC-8128 keyIds and allowed policies. Use `maxSignatureVerifications` to cap how many candidates are tried (default: 3). If `replayable: true`, you must provide either `replayableNotBefore` or `replayableInvalidated`.

### setHeaders (optional)

- **Type:** `(name: string, value: string) => void`

Callback to set response headers. When provided, `verifyRequest` sets `Accept-Signature` with the required components for each supported policy.

## Examples

These examples show strict, relaxed, and custom-component verification policies.

:::code-group

```typescript [Strict Policy]
const result = await verifyRequest(request, verifyMessage, nonceStore, {
  label: 'eth',
  strictLabel: true,
  replayable: false,
  maxValiditySec: 60,
  maxNonceWindowSec: 60,
  clockSkewSec: 5,
})
```

```typescript [Relaxed Policy]
const result = await verifyRequest(request, verifyMessage, nonceStore, {
  replayable: true,
  replayableNotBefore: async (keyid) => await getNotBeforeForKeyId(keyid),
  maxValiditySec: 300,
  clockSkewSec: 30,
})
```

```typescript [Custom Components]
const result = await verifyRequest(request, verifyMessage, nonceStore, {
  additionalRequestBoundComponents: ['x-custom-header'],
  classBoundPolicies: ['@authority', 'x-custom-header'],
})
```

:::

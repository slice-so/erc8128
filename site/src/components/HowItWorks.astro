---
const steps = [
  {
    id: "sign",
    title: "Sign",
    description:
      "The client signs with their wallet the request details — method, URL, headers, body, etc."
  },
  {
    id: "send",
    title: "Send",
    description:
      "The signed request is sent to the server, with the Ethereum address and signature attached."
  },
  {
    id: "verify",
    title: "Verify",
    description:
      "The server validates the signature and authenticates the request."
  }
]
---

<section class="relative overflow-hidden border-b border-border px-4 py-24 md:px-12 md:py-32">
  <!-- Grid background -->
  <div class="absolute inset-0 opacity-10 pointer-events-none bg-grid"></div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="mb-16 md:mb-20">
      <div class="text-xl font-bold uppercase tracking-[0.15em] flex items-center gap-4">
        <span class="block w-4 h-4 bg-white"></span>
        Request Lifecycle
      </div>
    </div>

    <div class="relative grid grid-cols-1 md:grid-cols-3 gap-16 md:gap-0" id="hiw-grid">
      <!-- Connection line fill (desktop only) -->
      <svg
        class="connection-flow hidden md:block absolute top-[120px] left-[16.67%] w-[66.67%] h-8 z-0"
        viewBox="0 0 800 32"
        preserveAspectRatio="none"
        aria-hidden="true"
      >
        <line x1="0" y1="16" x2="800" y2="16" stroke="rgba(255,255,255,0.06)" stroke-width="1" />
        <line
          id="hiw-line-fill"
          x1="0"
          y1="16"
          x2="800"
          y2="16"
          stroke="rgba(167, 139, 250, 0.9)"
          stroke-width="1.2"
          stroke-linecap="round"
          pathLength="1"
        />
      </svg>

      {
        steps.map((step, i) => (
          <div
            class={`hiw-step relative group z-10 ${i < steps.length - 1 ? "md:border-r md:border-white/[0.05]" : ""}`}
            data-step={step.id}
          >
            <div class="md:px-8 lg:px-12">
              <!-- Illustration container -->
              <div class="illustration-container relative h-48 md:h-52 mb-10 flex items-center justify-center">
                {/* ── SIGN ── */}
                {step.id === "sign" && (
                  <div class="sign-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Document outline */}
                      <g class="sign-doc">
                        <rect x="56" y="24" width="104" height="136" rx="3" fill="#0a0a0a" stroke="none" />
                        <rect
                          x="56"
                          y="24"
                          width="104"
                          height="136"
                          rx="3"
                          fill="none"
                          stroke="white"
                          stroke-width="0.8"
                          opacity="0.35"
                        />
                        <!-- removed fold corner accent -->
                      </g>

                      {/* Signing elements — fade in, then hold */}
                      <text
                        class="hiw-sign-el"
                        data-idx="0"
                        x="66"
                        y="55"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="7"
                        fill="white"
                        opacity="0"
                      >
                        POST /api/resource
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="1"
                        x="66"
                        y="70"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6.5"
                        fill="white"
                        opacity="0"
                      >
                        content-digest:
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="2"
                        x="70"
                        y="80"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6"
                        fill="white"
                        opacity="0"
                      >
                        sha-256=X48E9...
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="3"
                        x="66"
                        y="96"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6.5"
                        fill="white"
                        opacity="0"
                      >
                        @authority:
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="4"
                        x="70"
                        y="106"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6"
                        fill="white"
                        opacity="0"
                      >
                        api.example.com
                      </text>

                      {/* Divider */}
                      <line x1="76" y1="118" x2="140" y2="118" stroke="white" stroke-width="0.3" opacity="0.06" />

                      {/* Signature stroke */}
                      <path
                        id="hiw-sig"
                        d="M76 138 C88 124, 96 148, 108 134 C116 126, 124 142, 136 132"
                        stroke="white"
                        stroke-width="1.2"
                        stroke-linecap="round"
                        fill="none"
                        opacity="0"
                        stroke-dasharray="120"
                        stroke-dashoffset="120"
                      />
                    </svg>
                  </div>
                )}

                {/* ── SEND (Server) ── */}
                {step.id === "send" && (
                  <div class="send-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Server — squared icon based on server-reference.png */}
                      <rect x="64" y="40" width="112" height="112" rx="10" fill="#0a0a0a" stroke="none" />
                      <rect x="64" y="40" width="112" height="112" rx="10" fill="none" stroke="white" stroke-width="0.9" opacity="0.35" />

                      {/* Vents (left) */}
                      <rect x="78" y="62" width="8" height="68" rx="4" fill="white" opacity="0.16" />
                      <rect x="92" y="62" width="8" height="68" rx="4" fill="white" opacity="0.16" />
                      <rect x="106" y="62" width="8" height="68" rx="4" fill="white" opacity="0.16" />

                      {/* LEDs (center-right) */}
                      <circle class="hiw-led" data-idx="0" cx="134" cy="66" r="4" fill="white" opacity="0.08" />
                      <circle class="hiw-led" data-idx="1" cx="150" cy="66" r="4" fill="white" opacity="0.08" />
                      <circle class="hiw-led" data-idx="2" cx="166" cy="66" r="4" fill="white" opacity="0.08" />
                      <circle class="hiw-led" data-idx="3" cx="134" cy="86" r="4" fill="white" opacity="0.08" />
                      <circle class="hiw-led" data-idx="4" cx="150" cy="86" r="4" fill="white" opacity="0.08" />
                      <circle class="hiw-led" data-idx="5" cx="166" cy="86" r="4" fill="white" opacity="0.08" />

                      {/* Bottom bar */}
                      <rect x="124" y="122" width="44" height="8" rx="4" fill="white" opacity="0.16" />

                      {/* Processing indicator — dashed ring + glow + dot */}
                      <g class="hiw-proc">
                        <circle
                          id="hiw-proc-ring"
                          cx="156"
                          cy="122"
                          r="18"
                          stroke="white"
                          stroke-width="0.6"
                          fill="none"
                          opacity="0.06"
                          stroke-dasharray="4 4"
                        />
                        <circle id="hiw-proc-glow" cx="156" cy="122" r="10" fill="white" opacity="0" />
                        <circle id="hiw-proc-dot" cx="156" cy="122" r="3" fill="white" opacity="0.12" />
                      </g>
                    </svg>
                  </div>
                )}

                {/* ── VERIFY ── */}
                {step.id === "verify" && (
                  <div class="verify-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Verification pulse ring — expands outward */}
                      <circle id="hiw-v-ring" cx="120" cy="84" r="56" stroke="white" stroke-width="0.4" fill="none" opacity="0" />

                      {/* Shield */}
                      <path d="M120 22L76 42V84C76 114 94 138 120 150C146 138 164 114 164 84V42L120 22Z" fill="#0a0a0a" stroke="none" />
                      <path
                        d="M120 22L76 42V84C76 114 94 138 120 150C146 138 164 114 164 84V42L120 22Z"
                        stroke="white"
                        stroke-width="0.8"
                        fill="none"
                        opacity="0.3"
                      />

                      {/* Checkmark */}
                      <path
                        id="hiw-v-check"
                        d="M104 84L114 96L140 66"
                        stroke="white"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        fill="none"
                        opacity="0"
                        stroke-dasharray="60"
                        stroke-dashoffset="60"
                      />

                      {/* Address pill */}
                      <rect id="hiw-addr-pill" x="52" y="166" width="136" height="24" rx="12" stroke="white" stroke-width="0.5" fill="none" opacity="0.10" />
                      <text
                        id="hiw-addr-text"
                        x="120"
                        y="182"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="10"
                        fill="white"
                        text-anchor="middle"
                        letter-spacing="0.5"
                        opacity="0.18"
                      >
                        0x0000…0000
                      </text>
                    </svg>
                  </div>
                )}
              </div>

              <div class="text-center">
                <h3 class="text-lg font-bold uppercase mb-3 tracking-wide">{step.title}</h3>
                <p class="text-[15px] opacity-50 leading-[1.75] max-w-xs mx-auto">{step.description}</p>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  .bg-grid {
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  /* ═══════════════════════════════════════════════════════════
     HOVER
     ═══════════════════════════════════════════════════════════ */

  .illustration-container {
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .group:hover .illustration-container {
    transform: scale(1.03);
  }

  .illustration-container svg {
    transition: filter 0.6s ease;
  }

  .group:hover .illustration-container svg {
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.04));
  }

  /* ═══════════════════════════════════════════════════════════
     CONNECTION LINE FILL (desktop)
     ═══════════════════════════════════════════════════════════ */

  #hiw-line-fill {
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    opacity: 0;
  }

  .hiw-grid-active #hiw-line-fill {
    animation: hiwLineFill 2.6s cubic-bezier(0.16, 1, 0.3, 1) infinite;
  }

  @keyframes hiwLineFill {
    0% {
      stroke-dashoffset: 1;
      opacity: 0;
    }
    10% {
      opacity: 1;
    }
    55% {
      stroke-dashoffset: 0;
      opacity: 1;
    }
    85% {
      stroke-dashoffset: 0;
      opacity: 0.85;
    }
    100% {
      stroke-dashoffset: 0;
      opacity: 0;
    }
  }

  /* ═══════════════════════════════════════════════════════════
     SIGN (fade-in + hold)
     ═══════════════════════════════════════════════════════════ */

  .hiw-sign-el,
  #hiw-sig {
    opacity: 0;
  }

  .hiw-step.hiw-active .hiw-sign-el {
    animation: hiwSignFadeInHold 5.2s cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-sig {
    animation: hiwSigDrawHold 5.2s cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active .hiw-sign-el[data-idx="0"] {
    animation-delay: 0.10s;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="1"] {
    animation-delay: 0.22s;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="2"] {
    animation-delay: 0.34s;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="3"] {
    animation-delay: 0.46s;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="4"] {
    animation-delay: 0.58s;
  }

  @keyframes hiwSignFadeInHold {
    0% {
      opacity: 0;
    }
    14% {
      opacity: 0.55;
    }
    86% {
      opacity: 0.55;
    }
    100% {
      opacity: 0;
    }
  }

  @keyframes hiwSigDrawHold {
    0% {
      opacity: 0;
      stroke-dashoffset: 120;
    }
    22% {
      opacity: 0;
      stroke-dashoffset: 120;
    }
    42% {
      opacity: 0.65;
      stroke-dashoffset: 0;
    }
    86% {
      opacity: 0.65;
      stroke-dashoffset: 0;
    }
    100% {
      opacity: 0;
      stroke-dashoffset: 0;
    }
  }

  /* ═══════════════════════════════════════════════════════════
     SEND (processing)
     ═══════════════════════════════════════════════════════════ */

  #hiw-proc-ring {
    transform-origin: 156px 122px;
  }

  .hiw-step.hiw-active #hiw-proc-ring {
    animation: hiwProcSpin 1s linear infinite;
  }

  .hiw-step.hiw-active #hiw-proc-glow {
    animation: hiwProcPulse 1s ease-in-out infinite;
  }

  /* On mobile the processing animation always runs */
  @media (max-width: 767px) {
    #hiw-proc-ring {
      animation: hiwProcSpin 1s linear infinite;
    }

    #hiw-proc-glow {
      animation: hiwProcPulse 1s ease-in-out infinite;
    }

    #hiw-proc-dot {
      opacity: 0.22;
    }
  }

  @keyframes hiwProcSpin {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes hiwProcPulse {
    0% {
      opacity: 0;
    }
    50% {
      opacity: 0.08;
    }
    100% {
      opacity: 0;
    }
  }

  /* ═══════════════════════════════════════════════════════════
     VERIFY (pulse + check)
     ═══════════════════════════════════════════════════════════ */

  #hiw-v-check {
    transform-origin: 120px 82px;
  }

  #hiw-v-ring {
    transform-origin: 120px 84px;
  }

  .hiw-step.hiw-active #hiw-v-check {
    animation: hiwCheckDraw 6.0s cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-v-ring {
    animation: hiwVerifyRing 6.0s ease-out infinite;
  }

  @keyframes hiwCheckDraw {
    0% {
      opacity: 0;
      stroke-dashoffset: 60;
      transform: scale(1);
    }
    14% {
      opacity: 0;
      stroke-dashoffset: 60;
      transform: scale(1);
    }
    24% {
      opacity: 1;
      stroke-dashoffset: 0;
      transform: scale(1.06);
    }
    34% {
      opacity: 0.88;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
    86% {
      opacity: 0.88;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
    100% {
      opacity: 0;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
  }

  @keyframes hiwVerifyRing {
    0% {
      opacity: 0;
      transform: scale(0.85);
    }
    18% {
      opacity: 0;
      transform: scale(0.85);
    }
    34% {
      opacity: 0.12;
      transform: scale(1.02);
    }
    48% {
      opacity: 0;
      transform: scale(1.12);
    }
    100% {
      opacity: 0;
      transform: scale(1.12);
    }
  }

  /* ═══════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════ */

  @media (max-width: 767px) {
    .illustration-container {
      height: 11rem;
    }
  }
</style>

<script>
  (function () {
    const FINAL_ADDR = '0x71C7...d93A';
    const PLACEHOLDER = '0x0000…0000';
    const HEX = '0123456789abcdefABCDEF';

    function clamp(v, lo = 0, hi = 1) {
      return Math.max(lo, Math.min(hi, v));
    }

    /** progress=0 fully scrambled, progress=1 fully resolved. */
    function scramble(finalAddr, progress) {
      return finalAddr
        .split('')
        .map((ch, i) => {
          if (ch === '.' || ch === '…' || (ch === 'x' && i === 1) || (ch === '0' && i === 0)) return ch;
          const threshold = (progress * (finalAddr.length + 6) - i) / 5;
          if (threshold >= 1) return ch;
          return HEX[Math.floor(Math.random() * HEX.length)];
        })
        .join('');
    }

    function isMobile() {
      return window.matchMedia && window.matchMedia('(max-width: 767px)').matches;
    }

    function init() {
      const grid = document.getElementById('hiw-grid');
      if (!grid) return;

      const steps = Array.from(grid.querySelectorAll('.hiw-step'));

      // ── Desktop: trigger the connection line when the grid enters viewport ──
      const gridObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting) grid.classList.add('hiw-grid-active');
            else grid.classList.remove('hiw-grid-active');
          });
        },
        { threshold: 0.35 }
      );

      gridObserver.observe(grid);

      // ── Per-step activation: when each step enters viewport (mobile + desktop) ──
      const stepObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            const el = e.target;
            if (e.isIntersecting) el.classList.add('hiw-active');
            else el.classList.remove('hiw-active');
          });
        },
        { threshold: 0.4 }
      );

      steps.forEach((s) => stepObserver.observe(s));

      // ── VERIFY address: sequence per request ──
      // 1) Placeholder low opacity
      // 2) On signal received: high opacity + scramble
      // 3) After ~1s: resolve and stay
      steps
        .filter((s) => s.getAttribute('data-step') === 'verify')
        .forEach((verifyStep) => {
          const addrText = verifyStep.querySelector('#hiw-addr-text');
          const addrPill = verifyStep.querySelector('#hiw-addr-pill');
          if (!addrText || !addrPill) return;

          let rafId = null;
          let cycleStart = null;

          const CYCLE = 6000; // match CSS verify cadence
          const SIGNAL_AT = 500; // ms
          const RESOLVE_AFTER = 1000; // ms after signal

          function frame(ts) {
            if (!verifyStep.classList.contains('hiw-active')) {
              rafId = null;
              cycleStart = null;
              return;
            }

            if (cycleStart === null) cycleStart = ts;
            const t = (ts - cycleStart) % CYCLE;

            // Phase 1
            if (t < SIGNAL_AT) {
              addrText.textContent = PLACEHOLDER;
              addrText.setAttribute('opacity', '0.18');
              addrPill.setAttribute('opacity', '0.10');
            }
            // Phase 2
            else if (t < SIGNAL_AT + RESOLVE_AFTER) {
              const sp = clamp((t - SIGNAL_AT) / RESOLVE_AFTER);
              addrText.textContent = scramble(FINAL_ADDR, sp * 0.35);
              addrText.setAttribute('opacity', '0.62');
              addrPill.setAttribute('opacity', '0.38');
            }
            // Phase 3
            else {
              addrText.textContent = FINAL_ADDR;
              addrText.setAttribute('opacity', '0.65');
              addrPill.setAttribute('opacity', '0.40');
            }

            rafId = requestAnimationFrame(frame);
          }

          const start = () => {
            if (rafId) return;
            rafId = requestAnimationFrame(frame);
          };

          // Always run on mobile once mounted (but still only animates when step is in view)
          // Desktop: start when active
          const obs = new MutationObserver(() => {
            if (verifyStep.classList.contains('hiw-active')) start();
          });

          obs.observe(verifyStep, { attributes: true, attributeFilter: ['class'] });

          // If already active
          if (verifyStep.classList.contains('hiw-active')) start();
        });

      // Ensure SEND processing is always animated on mobile, even before scroll triggers
      if (isMobile()) {
        const sendStep = steps.find((s) => s.getAttribute('data-step') === 'send');
        if (sendStep) sendStep.classList.add('hiw-active');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

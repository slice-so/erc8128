---
const steps = [
  {
    id: "sign",
    title: "Sign",
    description:
      "The client signs with their wallet the request details — method, URL, headers, body, etc."
  },
  {
    id: "send",
    title: "Send",
    description:
      "The signed request is sent to the server, with the Ethereum address and signature attached."
  },
  {
    id: "verify",
    title: "Verify",
    description:
      "The server validates the signature and authenticates the request."
  }
]
---

<section class="relative overflow-hidden border-b border-border px-4 py-24 md:px-12 md:py-32">
  <!-- Grid background -->
  <div class="absolute inset-0 opacity-10 pointer-events-none bg-grid"></div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="mb-16 md:mb-20">
      <div class="text-xl font-bold uppercase tracking-[0.15em] flex items-center gap-4">
        <span class="block w-4 h-4 bg-white"></span>
        Request Lifecycle
      </div>
    </div>

    <div class="relative grid grid-cols-1 md:grid-cols-3 gap-16 md:gap-0" id="hiw-grid">
      <!-- Connection line fill (desktop only) -->
      <svg
        class="connection-flow hidden md:block absolute top-[104px] left-[16.67%] w-[66.67%] h-8 z-0"
        viewBox="0 0 800 32"
        preserveAspectRatio="none"
        aria-hidden="true"
      >
        <line x1="0" y1="16" x2="800" y2="16" stroke="rgba(255,255,255,0.06)" stroke-width="1" />
        <line
          id="hiw-line-fill"
          x1="0"
          y1="16"
          x2="800"
          y2="16"
          stroke="rgba(167, 139, 250, 0.9)"
          stroke-width="1.2"
          stroke-linecap="round"
          pathLength="1"
        />
        <line
          id="hiw-line-return"
          x1="0"
          y1="16"
          x2="800"
          y2="16"
          stroke="rgba(34, 197, 94, 0.95)"
          stroke-width="1.2"
          stroke-linecap="round"
          pathLength="1"
          transform="translate(800 0) scale(-1 1)"
        />
      </svg>

      {
        steps.map((step, i) => (
          <div
            class={`hiw-step relative group z-10 ${i < steps.length - 1 ? "md:border-r md:border-white/[0.05]" : ""}`}
            data-step={step.id}
          >
            <div class="md:px-8 lg:px-12">
              <!-- Illustration container -->
              <div class="illustration-container relative h-48 md:h-52 mb-10 flex items-center justify-center">
                {/* ── SIGN ── */}
                {step.id === "sign" && (
                  <div class="sign-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Document outline */}
                      <g class="sign-doc">
                        <rect x="68" y="24" width="104" height="136" rx="3" fill="#0a0a0a" stroke="none" />
                        <rect
                          class="hiw-doc-outline"
                          x="68"
                          y="24"
                          width="104"
                          height="136"
                          rx="3"
                          fill="none"
                          stroke="white"
                          stroke-width="0.8"
                          opacity="0.35"
                          pathLength="1"
                        />
                        <!-- removed fold corner accent -->
                      </g>

                      {/* Signing elements — fade in, then hold */}
                      <text
                        class="hiw-sign-el"
                        data-idx="0"
                        x="78"
                        y="55"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="7"
                        fill="white"
                        opacity="0"
                      >
                        POST /api/resource
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="1"
                        x="78"
                        y="70"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6.5"
                        fill="white"
                        opacity="0"
                      >
                        content-digest:
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="2"
                        x="82"
                        y="80"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6"
                        fill="white"
                        opacity="0"
                      >
                        sha-256=X48E9...
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="3"
                        x="78"
                        y="96"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6.5"
                        fill="white"
                        opacity="0"
                      >
                        @authority:
                      </text>
                      <text
                        class="hiw-sign-el"
                        data-idx="4"
                        x="82"
                        y="106"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="6"
                        fill="white"
                        opacity="0"
                      >
                        api.example.com
                      </text>
                      {/* Divider */}
                      <line x1="88" y1="118" x2="152" y2="118" stroke="white" stroke-width="0.3" opacity="0.06" />

                      {/* Signature stroke */}
                      <path
                        id="hiw-sig"
                        d="M88 138 C100 124, 108 148, 120 134 C128 126, 136 142, 148 132"
                        stroke="white"
                        stroke-width="1.2"
                        stroke-linecap="round"
                        fill="none"
                        opacity="0"
                        stroke-dasharray="120"
                        stroke-dashoffset="120"
                      />
                    </svg>
                  </div>
                )}

                {/* ── SEND (Server) ── */}
                {step.id === "send" && (
                  <div class="send-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Server */}
                      <rect x="64" y="40" width="112" height="112" rx="10" fill="#0a0a0a" stroke="none" />
                      <rect x="64" y="40" width="112" height="112" rx="10" fill="none" stroke="white" stroke-width="0.9" opacity="0.35" />
                      <rect x="78" y="56" width="84" height="12" rx="6" fill="white" opacity="0.08" />
                      <rect x="78" y="124" width="84" height="10" rx="5" fill="white" opacity="0.14" />

                      {/* Processing indicator — dashed ring + dot */}
                      <g class="hiw-proc">
                        <circle
                          id="hiw-proc-ring"
                          cx="120"
                          cy="96"
                          r="18"
                          stroke="white"
                          stroke-width="0.7"
                          fill="none"
                          opacity="0.12"
                          stroke-dasharray="6 6"
                        />
                        <circle id="hiw-proc-dot" cx="120" cy="96" r="3" fill="white" opacity="0.22" />
                      </g>
                    </svg>
                  </div>
                )}

                {/* ── VERIFY ── */}
                {step.id === "verify" && (
                  <div class="verify-illustration relative w-full h-full">
                    <svg class="w-full h-full" viewBox="0 0 240 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      {/* Verification pulse ring — expands outward */}
                      <circle id="hiw-v-ring" cx="120" cy="84" r="56" stroke="white" stroke-width="0.4" fill="none" opacity="0" />

                      {/* Shield */}
                      <path d="M120 22L76 42V84C76 114 94 138 120 150C146 138 164 114 164 84V42L120 22Z" fill="#0a0a0a" stroke="none" />
                      <path
                        d="M120 22L76 42V84C76 114 94 138 120 150C146 138 164 114 164 84V42L120 22Z"
                        stroke="white"
                        stroke-width="0.8"
                        fill="none"
                        opacity="0.3"
                      />

                      {/* Checkmark */}
                      <path
                        id="hiw-v-check"
                        d="M104 84L114 96L140 66"
                        stroke="white"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        fill="none"
                        opacity="0"
                        stroke-dasharray="60"
                        stroke-dashoffset="60"
                      />

                      {/* Address pill */}
                      <rect id="hiw-addr-pill" x="52" y="166" width="136" height="24" rx="12" stroke="white" stroke-width="0.5" fill="none" opacity="0.10" />
                      <text
                        id="hiw-addr-text"
                        x="120"
                        y="182"
                        font-family="'SF Mono','Fira Code','Cascadia Code',monospace"
                        font-size="10"
                        fill="white"
                        text-anchor="middle"
                        letter-spacing="0.5"
                        opacity="0.18"
                      >
                        0x0000…0000
                      </text>
                    </svg>
                  </div>
                )}
              </div>

              <div class="text-center">
                <h3 class="text-lg font-bold uppercase mb-3 tracking-wide">{step.title}</h3>
                <p class="text-[15px] opacity-50 leading-[1.75] max-w-xs mx-auto">{step.description}</p>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  .bg-grid {
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  #hiw-grid {
    /* Keep these in sync with JS timings */
    --hiw-cycle: 5900ms;
    --hiw-sign-text: 300ms;
    --hiw-sign-sig: 500ms;
    --hiw-line-delay: 100ms; /* pause after Sign completes */
    --hiw-line-to-send: 800ms;
    --hiw-process-delay: 0ms;
    --hiw-process-spin: 400ms;
    --hiw-spinner-fade: 100ms;
    --hiw-line-to-verify: 800ms;
    --hiw-scramble: 600ms;
    --hiw-return: 500ms;
    --hiw-hold: 500ms;
    --hiw-fade-out: 400ms;
  }

  /* ═══════════════════════════════════════════════════════════
     HOVER
     ═══════════════════════════════════════════════════════════ */

  .illustration-container {
    transition: transform 0.24s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @media (hover: hover) and (pointer: fine) {
    .group:hover .illustration-container {
      transform: scale(1.015);
    }
  }

  /* ═══════════════════════════════════════════════════════════
     CONNECTION LINE FILL (desktop)
     ═══════════════════════════════════════════════════════════ */

  #hiw-line-fill {
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    opacity: 0;
  }

  #hiw-line-return {
    stroke-dasharray: 1;
    stroke-dashoffset: 1;
    opacity: 0;
  }

  .hiw-grid-active #hiw-line-fill {
    animation: none;
  }
  /* ═══════════════════════════════════════════════════════════
     SIGN (fade-in + hold)
     ═══════════════════════════════════════════════════════════ */

  .hiw-sign-el,
  #hiw-sig,
  .hiw-doc-outline {
    opacity: 0;
  }

  .hiw-step.hiw-active .hiw-sign-el {
    animation: hiwSignFadeInHold var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-sig {
    animation: hiwSigDrawHold var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active .hiw-doc-outline {
    animation: hiwDocOutline var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active .hiw-sign-el[data-idx="0"] {
    animation-delay: 0ms;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="1"] {
    animation-delay: 80ms;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="2"] {
    animation-delay: 160ms;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="3"] {
    animation-delay: 220ms;
  }
  .hiw-step.hiw-active .hiw-sign-el[data-idx="4"] {
    animation-delay: 260ms;
  }
  @keyframes hiwSignFadeInHold {
    0% { opacity: 0; }
    5.08% { opacity: 0.55; }
    93.22% { opacity: 0.55; }
    100% { opacity: 0; }
  }

  @keyframes hiwDocOutline {
    0% {
      opacity: 0;
      stroke-dasharray: 1;
      stroke-dashoffset: 1;
    }
    5.08% {
      opacity: 0.35;
      stroke-dashoffset: 0;
    }
    93.22% {
      opacity: 0.35;
      stroke-dashoffset: 0;
    }
    100% {
      opacity: 0;
      stroke-dashoffset: 0;
    }
  }

  @keyframes hiwSigDrawHold {
    0% {
      opacity: 1;
      stroke-dashoffset: 120;
    }
    5.08% {
      opacity: 1;
      stroke-dashoffset: 120;
    }
    13.56% {
      opacity: 1;
      stroke-dashoffset: 0;
    }
    93.22% {
      opacity: 1;
      stroke-dashoffset: 0;
    }
    100% {
      opacity: 0;
      stroke-dashoffset: 0;
    }
  }

  /* ═══════════════════════════════════════════════════════════
     SEND (processing)
     ═══════════════════════════════════════════════════════════ */

  #hiw-proc-ring {
    transform-origin: 120px 96px;
    will-change: transform, opacity;
  }

  .hiw-step.hiw-active #hiw-proc-ring {
    animation: hiwProcSpin var(--hiw-cycle) linear infinite;
  }

  @media (max-width: 767px) {
    #hiw-proc-dot {
      opacity: 0.22;
    }
  }
  @keyframes hiwProcSpin {
    0% {
      opacity: 0;
      transform: rotate(0deg);
    }
    28.81% {
      opacity: 0;
      transform: rotate(0deg);
    }
    /* Fade in (<=100ms) */
    30.5% {
      opacity: 1;
      transform: rotate(0deg);
    }
    /* Spin for 0.4s */
    33.9% {
      opacity: 1;
      transform: rotate(360deg);
    }
    /* Fade out (<=100ms) */
    35.59% {
      opacity: 0;
      transform: rotate(360deg);
    }
    100% {
      opacity: 0;
      transform: rotate(360deg);
    }
  }

  /* ═══════════════════════════════════════════════════════════
     VERIFY (pulse + check)
     ═══════════════════════════════════════════════════════════ */

  #hiw-v-check {
    transform-origin: 120px 82px;
    will-change: transform, opacity;
  }

  #hiw-v-ring {
    transform-origin: 120px 84px;
    will-change: transform, opacity;
  }

  .hiw-step.hiw-active #hiw-v-check {
    animation: hiwCheckDraw var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-v-ring {
    animation: hiwVerifyRing var(--hiw-cycle) ease-out infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-addr-text {
    animation: hiwVerifyAddr var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }

  .hiw-step.hiw-active #hiw-addr-pill {
    animation: hiwVerifyPill var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
    animation-fill-mode: both;
  }
  @keyframes hiwCheckDraw {
    0% {
      opacity: 0;
      stroke-dashoffset: 60;
      transform: scale(1);
    }
    59.32% {
      opacity: 0;
      stroke-dashoffset: 60;
      transform: scale(1);
    }
    64.4% {
      opacity: 1;
      stroke-dashoffset: 0;
      transform: scale(1.06);
    }
    69.49% {
      opacity: 0.88;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
    93.22% {
      opacity: 0.88;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
    100% {
      opacity: 0;
      stroke-dashoffset: 0;
      transform: scale(1);
    }
  }

  @keyframes hiwVerifyRing {
    0% {
      opacity: 0;
      transform: scale(0.85);
    }
    59.32% {
      opacity: 0;
      transform: scale(0.85);
    }
    64.4% {
      opacity: 0.12;
      transform: scale(1.02);
    }
    69.49% {
      opacity: 0;
      transform: scale(1.12);
    }
    100% {
      opacity: 0;
      transform: scale(1.12);
    }
  }

  @keyframes hiwVerifyAddr {
    0% { opacity: 0.18; }
    49.15% { opacity: 0.62; }
    59.32% { opacity: 0.62; }
    93.22% { opacity: 0.65; }
    100% { opacity: 0.18; }
  }

  @keyframes hiwVerifyPill {
    0% { opacity: 0.1; }
    49.15% { opacity: 0.38; }
    59.32% { opacity: 0.38; }
    93.22% { opacity: 0.4; }
    100% { opacity: 0.1; }
  }

  /* ═══════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════ */

  @media (max-width: 767px) {
    .illustration-container {
      height: 11rem;
    }

    .hiw-step[data-step="sign"] {
      --hiw-cycle: 2600ms;
    }

    .hiw-step[data-step="send"] {
      --hiw-cycle: 600ms;
    }

    .hiw-step[data-step="verify"] {
      --hiw-cycle: 2000ms;
    }

    .hiw-step.hiw-active #hiw-line-fill {
      animation: none;
    }

    .hiw-step[data-step="send"].hiw-active #hiw-proc-ring {
      animation: hiwProcSpinMobile var(--hiw-cycle) linear infinite;
    }

    .hiw-step[data-step="verify"].hiw-active #hiw-v-check {
      animation: hiwCheckDrawMobile var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
      animation-fill-mode: both;
    }

    .hiw-step[data-step="verify"].hiw-active #hiw-v-ring {
      animation: hiwVerifyRingMobile var(--hiw-cycle) ease-out infinite;
      animation-fill-mode: both;
    }

    .hiw-step[data-step="verify"].hiw-active #hiw-addr-text {
      animation: hiwVerifyAddrMobile var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
      animation-fill-mode: both;
    }

    .hiw-step[data-step="verify"].hiw-active #hiw-addr-pill {
      animation: hiwVerifyPillMobile var(--hiw-cycle) cubic-bezier(0.16, 1, 0.3, 1) infinite;
      animation-fill-mode: both;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .illustration-container,
    .illustration-container svg {
      transition: none;
    }

    #hiw-line-fill,
    .hiw-step .hiw-sign-el,
    .hiw-step #hiw-sig,
    .hiw-step #hiw-proc-ring,
    .hiw-step #hiw-addr-text,
    .hiw-step #hiw-addr-pill,
    .hiw-step #hiw-v-check,
    .hiw-step #hiw-v-ring {
      animation: none;
    }

    #hiw-line-fill {
      opacity: 1;
      stroke-dashoffset: 0;
    }

    .hiw-step .hiw-sign-el {
      opacity: 0.55;
    }

    .hiw-step #hiw-sig {
      opacity: 0.65;
      stroke-dashoffset: 0;
    }

    .hiw-step #hiw-v-check {
      opacity: 0.88;
      stroke-dashoffset: 0;
      transform: scale(1);
    }

    .hiw-step #hiw-v-ring {
      opacity: 0.12;
      transform: scale(1.02);
    }
  }
</style>

<script>
  (function () {
    const FINAL_ADDR = '0x71C7...d93A';
    const PLACEHOLDER = '0x0000…0000';
    const HEX = '0123456789abcdefABCDEF';
    const SIGN_TEXT_MS = 300;
    const SIGN_SIG_MS = 500;
    const LINE_DELAY_MS = 100;
    const LINE_TO_SEND_MS = 800;

    // Send / processing: arrive → wait 0.4s → fade in (<=100ms) → spin 0.4s → fade out (<=100ms)
    const PROCESS_DELAY_MS = 0;
    const SPINNER_FADE_MS = 100;
    const PROCESS_SPIN_MS = 200;
    const PROCESS_TOTAL_MS = PROCESS_DELAY_MS + SPINNER_FADE_MS + PROCESS_SPIN_MS + SPINNER_FADE_MS;

    // Purple line leg 2 (send → verify)
    const LINE_TO_VERIFY_MS = 800;

    // Verify / scramble
    const SCRAMBLE_MS = 600;
    const RESOLVE_MS = 1000;
    const RETURN_MS = 500;
    const HOLD_MS = 500;
    const FADE_OUT_MS = 400;

    const SCRAMBLE_TICK = 80;
    const STAGGER = 32;

    const DESKTOP_CYCLE_MS =
      SIGN_TEXT_MS +
      SIGN_SIG_MS +
      LINE_DELAY_MS +
      LINE_TO_SEND_MS +
      PROCESS_TOTAL_MS +
      LINE_TO_VERIFY_MS +
      SCRAMBLE_MS +
      RESOLVE_MS +
      RETURN_MS +
      HOLD_MS +
      FADE_OUT_MS;

    const MOBILE_VERIFY_CYCLE_MS = SCRAMBLE_MS + RESOLVE_MS + RETURN_MS + HOLD_MS + FADE_OUT_MS;

    function clamp(v: number, lo = 0, hi = 1) {
      return Math.max(lo, Math.min(hi, v));
    }

    function isStaticChar(ch: string, index: number) {
      return ch === '.' || ch === '…' || (ch === 'x' && index === 1) || (ch === '0' && index === 0);
    }

    function supportsReducedMotion() {
      return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    }

    function createVerifyAnimator(verifyStep: HTMLElement) {
      const addrText = verifyStep.querySelector<SVGTextElement>('#hiw-addr-text');
      const addrPill = verifyStep.querySelector<SVGRectElement>('#hiw-addr-pill');
      if (!addrText || !addrPill) return null;

      let scrambleInterval: number | null = null;
      let timers: number[] = [];

      const setPlaceholder = () => {
        addrText.textContent = PLACEHOLDER;
      };

      const setFinal = () => {
        addrText.textContent = FINAL_ADDR;
      };

      const clearTimers = () => {
        timers.forEach((t) => clearTimeout(t));
        timers = [];
        if (scrambleInterval !== null) {
          clearInterval(scrambleInterval);
          scrambleInterval = null;
        }
      };

      const runCycle = (startDelay: number, cycleMs: number) => {
        clearTimers();
        if (!verifyStep.classList.contains('hiw-active')) return;

        setPlaceholder();

        const signalTimer = setTimeout(() => {
          const start = performance.now();
          scrambleInterval = window.setInterval(() => {
            const t = performance.now() - start;
            const tick = Math.floor(t / SCRAMBLE_TICK);
            const chars = FINAL_ADDR.split('');
            const perCharDelay = Math.min(STAGGER, SCRAMBLE_MS / Math.max(1, chars.length - 1));
            const perCharDuration = Math.max(120, SCRAMBLE_MS - perCharDelay * (chars.length - 1));
            const totalDuration = SCRAMBLE_MS;
            const output = chars
              .map((ch, i) => {
                if (isStaticChar(ch, i)) return ch;
                const local = clamp((t - i * perCharDelay) / perCharDuration);
                if (local >= 1) return ch;
                return HEX[(i * 13 + tick * 7) % HEX.length];
              })
              .join('');
            addrText.textContent = output;
            if (t >= totalDuration) {
              if (scrambleInterval !== null) {
                clearInterval(scrambleInterval);
                scrambleInterval = null;
              }
              setFinal();
            }
          }, SCRAMBLE_TICK);
        }, startDelay);

        const fadeOutTimer = setTimeout(() => {
          // reset as we fade back to idle
          setPlaceholder();
        }, startDelay + SCRAMBLE_MS + RESOLVE_MS + RETURN_MS + HOLD_MS);

        const nextTimer = window.setTimeout(() => runCycle(startDelay, cycleMs), cycleMs);
        timers.push(signalTimer, fadeOutTimer, nextTimer);
      };

      return { runCycle, stop: clearTimers, setFinal };
    }

    function init() {
      const grid = document.getElementById('hiw-grid');
      if (!grid) return;

      const steps = Array.from(grid.querySelectorAll('.hiw-step'));
      const lineFill = grid.querySelector<SVGLineElement>('#hiw-line-fill');
      const lineReturn = grid.querySelector<SVGLineElement>('#hiw-line-return');
      const isMobile = window.matchMedia && window.matchMedia('(max-width: 767px)').matches;
      const cycleMs = isMobile ? MOBILE_VERIFY_CYCLE_MS : DESKTOP_CYCLE_MS;
      const verifyDelayMs = isMobile
        ? 0
        : SIGN_TEXT_MS +
          SIGN_SIG_MS +
          LINE_DELAY_MS +
          LINE_TO_SEND_MS +
          PROCESS_TOTAL_MS +
          LINE_TO_VERIFY_MS;
      const reduceMotion = supportsReducedMotion();

      const verifyStep = steps.find((s) => s.getAttribute('data-step') === 'verify') as HTMLElement | undefined;
      const verifyAnimator = verifyStep ? createVerifyAnimator(verifyStep) : null;

      if (reduceMotion) {
        if (verifyAnimator) verifyAnimator.setFinal();
        return;
      }

      let lineAnimation: Animation | null = null;
      let lineReturnAnimation: Animation | null = null;
      const startLine = () => {
        if (!lineFill) return;
        if (lineAnimation) lineAnimation.cancel();
        if (lineReturnAnimation) lineReturnAnimation.cancel();
        const lineStart = (SIGN_TEXT_MS + SIGN_SIG_MS + LINE_DELAY_MS) / DESKTOP_CYCLE_MS;
        const lineSendArrive =
          (SIGN_TEXT_MS + SIGN_SIG_MS + LINE_DELAY_MS + LINE_TO_SEND_MS) / DESKTOP_CYCLE_MS;
        const lineSendPauseEnd =
          (SIGN_TEXT_MS + SIGN_SIG_MS + LINE_DELAY_MS + LINE_TO_SEND_MS + PROCESS_TOTAL_MS) /
          DESKTOP_CYCLE_MS;
        const lineVerifyArrive =
          (SIGN_TEXT_MS +
            SIGN_SIG_MS +
            LINE_DELAY_MS +
            LINE_TO_SEND_MS +
            PROCESS_TOTAL_MS +
            LINE_TO_VERIFY_MS) /
          DESKTOP_CYCLE_MS;

        const resolveEnd =
          (SIGN_TEXT_MS +
            SIGN_SIG_MS +
            LINE_DELAY_MS +
            LINE_TO_SEND_MS +
            PROCESS_TOTAL_MS +
            LINE_TO_VERIFY_MS +
            SCRAMBLE_MS +
            RESOLVE_MS) /
          DESKTOP_CYCLE_MS;

        const returnEnd =
          (SIGN_TEXT_MS +
            SIGN_SIG_MS +
            LINE_DELAY_MS +
            LINE_TO_SEND_MS +
            PROCESS_TOTAL_MS +
            LINE_TO_VERIFY_MS +
            SCRAMBLE_MS +
            RESOLVE_MS +
            RETURN_MS) /
          DESKTOP_CYCLE_MS;

        const holdEnd =
          (SIGN_TEXT_MS +
            SIGN_SIG_MS +
            LINE_DELAY_MS +
            LINE_TO_SEND_MS +
            PROCESS_TOTAL_MS +
            LINE_TO_VERIFY_MS +
            SCRAMBLE_MS +
            RESOLVE_MS +
            RETURN_MS +
            HOLD_MS) /
          DESKTOP_CYCLE_MS;

        lineAnimation = lineFill.animate(
          [
            { strokeDashoffset: 1, opacity: 0, offset: 0 },
            { strokeDashoffset: 1, opacity: 0, offset: lineStart },

            // Segment 1: client → send (stop at 50%)
            { strokeDashoffset: 0.5, opacity: 1, offset: lineSendArrive },

            // Wait at Send for full processing animation
            { strokeDashoffset: 0.5, opacity: 1, offset: lineSendPauseEnd },

            // Segment 2: send → verify
            { strokeDashoffset: 0, opacity: 1, offset: lineVerifyArrive },

            // Keep visible while scrambling / verifying
            { strokeDashoffset: 0, opacity: 1, offset: resolveEnd },

            // Keep visible until the green return line finishes
            { strokeDashoffset: 0, opacity: 1, offset: returnEnd },

            // Hold, then fade out back to idle
            { strokeDashoffset: 0, opacity: 1, offset: holdEnd },
            { strokeDashoffset: 0, opacity: 0, offset: 1 }
          ],
          {
            duration: DESKTOP_CYCLE_MS,
            iterations: Infinity,
            easing: 'cubic-bezier(0.16, 1, 0.3, 1)'
          }
        );

        if (lineReturn) {
          lineReturnAnimation = lineReturn.animate(
            [
              { strokeDashoffset: 1, opacity: 0, offset: 0 },
              { strokeDashoffset: 1, opacity: 0, offset: resolveEnd },
              { strokeDashoffset: 0, opacity: 1, offset: returnEnd },
              { strokeDashoffset: 0, opacity: 1, offset: holdEnd },
              { strokeDashoffset: 0, opacity: 0, offset: 1 }
            ],
            {
              duration: DESKTOP_CYCLE_MS,
              iterations: Infinity,
              easing: 'cubic-bezier(0.16, 1, 0.3, 1)'
            }
          );
        }
      };

      const stopLine = () => {
        if (lineAnimation) {
          lineAnimation.cancel();
          lineAnimation = null;
        }
        if (lineReturnAnimation) {
          lineReturnAnimation.cancel();
          lineReturnAnimation = null;
        }
      };

      if (!('IntersectionObserver' in window)) {
        steps.forEach((s) => s.classList.add('hiw-active'));
        grid.classList.add('hiw-grid-active');
        if (!isMobile) startLine();
        if (verifyAnimator) verifyAnimator.runCycle(verifyDelayMs, cycleMs);
        return;
      }

      // ── Desktop: sync full sequence when the grid enters viewport ──
      if (!isMobile) {
        const gridObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((e) => {
              if (e.isIntersecting) {
                grid.classList.add('hiw-grid-active');
                steps.forEach((s) => s.classList.add('hiw-active'));
                startLine();
                if (verifyAnimator) verifyAnimator.runCycle(verifyDelayMs, cycleMs);
              } else {
                grid.classList.remove('hiw-grid-active');
                steps.forEach((s) => s.classList.remove('hiw-active'));
                stopLine();
                if (verifyAnimator) verifyAnimator.stop();
              }
            });
          },
          { threshold: 0.35 }
        );

        gridObserver.observe(grid);
        return;
      }

      // ── Mobile: per-step activation and independent cadence ──
      const stepObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            const el = e.target;
            if (e.isIntersecting) el.classList.add('hiw-active');
            else el.classList.remove('hiw-active');

            if (verifyAnimator && el === verifyStep) {
              if (e.isIntersecting) verifyAnimator.runCycle(0, cycleMs);
              else verifyAnimator.stop();
            }
          });
        },
        { threshold: 0.4 }
      );

      steps.forEach((s) => stepObserver.observe(s));
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
